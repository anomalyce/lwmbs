name: linux test

on:
  workflow_dispatch:
  push:

jobs:
  source-fetch:
    name: Cache PHP ${{ matrix.php-version }} sources
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        php-version: ["8.1", "8.0"]
      max-parallel: 2
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Update sources
        shell: bash
        id: src_upgrade
        run: |
          mkdir build
          printf '::set-output name=hash::'
          php fetch_source.php ./src.json ${{ matrix.php-version }} --hash
          echo

      - name: Cache sources
        uses: actions/cache@v3
        with:
          path: |
            build/src
            build/downloads
          # note: match this
          key: linux-src-v3-${{ steps.src_upgrade.outputs.hash }}

  cache:
    needs:
      - source-fetch
    name: Cache ${{ matrix.libc }} PHP ${{ matrix.php-version }} libraries
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        php-version: ["8.1", "8.0"]
        libc: ['musl', 'glibc']
      max-parallel: 4
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Update sources
        shell: bash
        id: src_upgrade
        run: |
          mkdir build
          printf '::set-output name=hash::'
          php fetch_source.php ./src.json ${{ matrix.php-version }} --hash
          echo

      - name: Cache sources
        uses: actions/cache@v3
        with:
          path: |
            build/src
            build/downloads
          # note: match this
          key: linux-src-v3-${{ steps.src_upgrade.outputs.hash }}

      - name: Cache libs
        id: libs-cache
        uses: actions/cache@v3
        with:
          path: |
            build/lib
            build/include
          # note: match this
          key: linux-lib-${{ matrix.libc }}-v3-${{ steps.src_upgrade.outputs.hash }}

      - name: Prepare and fetch sources
        shell: bash
        if: steps.libs-cache.outputs.cache-hit != 'true'
        working-directory: build
        run: |
          sudo apt-get install -yy --no-install-recommends \
            bison re2c ${{ matrix.libc == 'musl' && 'musl musl-tools' || '' }}
          php ../fetch_source.php ../src.json ${{ matrix.php-version }} --shallow-clone

      # - name: Setup tmate session
      #   uses: mxschmitt/action-tmate@v3

      - name: Build libraries
        shell: bash
        working-directory: build
        run: |
          php ../build_libs.php

  build:
    needs:
      - cache
    name: PHP ${{ matrix.php-version }} ${{ matrix.libc }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        php-version: ["8.1", "8.0"]
        libc: ['musl', 'glibc']
      max-parallel: 4
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Update sources
        shell: bash
        id: src_upgrade
        run: |
          mkdir build
          printf '::set-output name=hash::'
          php fetch_source.php ./src.json ${{ matrix.php-version }} --hash
          echo

      - name: Cache sources
        uses: actions/cache@v3
        with:
          path: |
            build/src
            build/downloads
          # note: match this
          key: linux-src-v3-${{ steps.src_upgrade.outputs.hash }}

      - name: Cache libs
        uses: actions/cache@v3
        with:
          path: |
            build/lib
            build/include
          # note: match this
          key: linux-lib-${{ matrix.libc }}-v3-${{ steps.src_upgrade.outputs.hash }}

      - name: Prepare and fetch sources
        shell: bash
        working-directory: build
        run: |
          sudo apt-get install -yy --no-install-recommends \
            bison re2c ${{ matrix.libc == 'musl' && 'musl musl-tools' || '' }}
          mkdir \
            ../micro_shared \
            ../micro_static \
            ../cli_shared \
            ../cli_static
          php ../fetch_source.php ../src.json ${{ matrix.php-version }} --shallow-clone

      # - name: Setup tmate session
      #   uses: mxschmitt/action-tmate@v3

      - name: Build micro
        shell: bash
        working-directory: build
        run: |
          php ../build_micro.php
          cp src/php-src/sapi/micro/micro.sfx src/php-src/sapi/micro/micro.sfx.debug ../micro_shared

      - name: Upload artifact for micro
        uses: actions/upload-artifact@v3
        with:
          name: micro_shared_${{ matrix.php-version }}_${{ matrix.libc }}_${{ steps.src_upgrade.outputs.hash }}
          path: |
            micro_shared

      - name: Build micro all-static
        shell: bash
        working-directory: build
        run: |
          php ../build_micro.php all-static
          cp src/php-src/sapi/micro/micro.sfx src/php-src/sapi/micro/micro.sfx.debug ../micro_static

      - name: Upload artifact for micro static
        uses: actions/upload-artifact@v3
        with:
          name: micro_static_${{ matrix.php-version }}_${{ matrix.libc }}_${{ steps.src_upgrade.outputs.hash }}
          path: |
            micro_static

      - name: Build cli
        shell: bash
        working-directory: build
        run: |
          php ../build_cli.php
          cp src/php-src/sapi/cli/php src/php-src/sapi/cli/php.debug ../cli_shared

      - name: Upload artifact for cli
        uses: actions/upload-artifact@v3
        with:
          name: cli_shared_${{ matrix.php-version }}_${{ matrix.libc }}_${{ steps.src_upgrade.outputs.hash }}
          path: |
            cli_shared

      - name: Build cli all-static
        shell: bash
        working-directory: build
        run: |
          php ../build_cli.php  all-static
          cp src/php-src/sapi/cli/php src/php-src/sapi/cli/php.debug ../cli_static

      - name: Upload artifact for cli static
        uses: actions/upload-artifact@v3
        with:
          name: cli_static_${{ matrix.php-version }}_${{ matrix.libc }}_${{ steps.src_upgrade.outputs.hash }}
          path: |
            cli_static

      - name: Remove php src to avoid cache
        shell: bash
        working-directory: build
        run: |
          rm -rf src/php-src
